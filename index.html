<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>הזמנות פרחים - השוזר</title>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

  <!-- Initialize Firebase -->
  <script>
    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyC2zCq88ENRnWsScjVgp2INp7vtnR8ck0M",
        authDomain: "hashozerdb.firebaseapp.com",
        projectId: "hashozerdb",
        databaseURL: "https://hashozerdb-default-rtdb.europe-west1.firebasedatabase.app",
        storageBucket: "hashozerdb.firebasestorage.app",
        messagingSenderId: "159442413900",
        appId: "1:159442413900:web:f1fe5222ee2ce9de1e47e9"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Add error logging for database connection
    db.ref('.info/connected').on('value', function(snap) {
      if (snap.val() === true) {
        console.log('Connected to Firebase Database');
      } else {
        console.log('Disconnected from Firebase Database');
      }
    }, function(error) {
      console.error('Firebase connection error:', error);
    });

    // Firebase paths
    const PATHS = {
      ITEMS: 'flower_items',
      FLOWERS: 'flower_types',
      EXPENSES: 'expenses',
      ORDERS: 'orders'
    };

    // Default flowers for initialization
    const defaultFlowers = {
      "ורדים": 10,
      "כלניות": 8,
      "נוריות": 7,
      "גרברות": 12
    };
  </script>
  <style>
    /* Splash Screen Styles */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      width: 100dvw;
      height: 100vh;
      height: 100dvh;
      background: white;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      opacity: 1;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      margin: 0;
      padding: 0;
      overflow: hidden;
      box-sizing: border-box;
      -webkit-box-sizing: border-box;
    }

    .container {
      display: none; /* Hide container initially */
    }

    .container.show {
      display: block; /* Show container when class is added */
    }

    #splash-screen.fade-out {
      opacity: 0;
      transform: scale(1.1);
      pointer-events: none;
    }

    #splash-screen img {
      width: 150px;
      height: auto;
      margin-bottom: 20px;
      animation: pulse 2s infinite;
      -webkit-user-select: none;
      user-select: none;
    }

    #splash-screen h1 {
      font-size: 2rem;
      color: #2c3e50;
      margin: 0;
      padding: 0;
      text-align: center;
      width: 100%;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @media (max-width: 600px) {
      #splash-screen {
        padding: 0;
        min-height: -webkit-fill-available;
        min-width: -webkit-fill-available;
        width: 100%;
        width: 100dvw;
        height: 100%;
        height: 100dvh;
        position: fixed;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        margin: 0;
        border: 0;
      }
      
      #splash-screen img {
        width: 120px;
        margin-bottom: 16px;
      }
      
      #splash-screen h1 {
        font-size: 1.5rem;
        padding: 0 20px;
        width: 100%;
        box-sizing: border-box;
      }
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      direction: rtl;
      font-size: 16px;
      line-height: 1.5;
    }
    .container {
      max-width: 1000px;
      margin: auto;
      padding: 1rem;
    }
    .item-form, .report-section {
      background: #f9f9f9;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .flex-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1rem;
      padding: 0 0.5rem;
    }
    .flex-row > * {
      flex: 1 1 200px;
    }
    input, select, button {
      width: 100%;
      padding: 0.75rem;
      margin-top: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      font-size: 1rem;
      box-sizing: border-box;
    }
    button {
      background: #2c3e50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      min-height: 44px; /* For better touch targets */
    }
    button:hover {
      background: #34495e;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 12px 8px;
      text-align: right;
    }
    th {
      background-color: #f5f5f5;
    }
    .summary {
      font-weight: bold;
      color: #2c3e50;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #eee;
    }
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.5);
      padding: 0;
    }
    .modal-content {
      background-color: #fefefe;
      margin: 10px auto;
      padding: 20px;
      border-radius: 0.75rem;
      width: 90%;
      max-width: 600px;
      position: relative;
    }
    .close {
      position: absolute;
      right: 20px;
      top: 10px;
      color: #666;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      padding: 0 8px;
    }
    /* Mobile-specific styles */
    @media (max-width: 600px) {
      body {
        font-size: 14px;
      }
      .container {
        padding: 0.5rem 1rem;
      }
      .item-form, .report-section {
        padding: 1.25rem;
        margin: 0 0.5rem 1rem 0.5rem;
        border-radius: 0.5rem;
      }
      .flex-row {
        flex-direction: column;
        gap: 0.5rem;
        padding: 0 0.75rem;
      }
      .flex-row > * {
        flex: 1 1 auto;
      }
      input, select, button {
        padding: 0.8rem;
        font-size: 16px; /* Prevent zoom on iOS */
        margin: 0.25rem 0;
      }
      table {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
      }
      th, td {
        padding: 8px;
      }
      .modal-content {
        margin: 0;
        width: 100%;
        height: 100%;
        border-radius: 0;
      }
      h1 {
        font-size: 1.5rem;
        margin: 1rem 0;
      }
      h2 {
        font-size: 1.25rem;
      }
      #ingredientsList {
        padding-right: 20px;
      }
      .ui-autocomplete {
        max-height: 50vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }
      .header-container h1 {
        font-size: 1.3rem;
      }
      .settings-button {
        margin: 0;
      }
    }
    .header-container {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.5rem;
    }
    .settings-button {
      background: transparent;
      color: #2c3e50;
      width: auto;
      min-width: 44px;
      height: 44px;
      padding: 0.5rem;
      margin: 0;
      border: 1px solid #ddd;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .settings-button:hover {
      background: #f5f5f5;
      color: #2c3e50;
      transform: rotate(30deg);
    }
    .settings-button i {
      font-size: 1.2rem;
    }
    .button-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 0 0.5rem;
    }
    .button-group button {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }
    .print-button {
      background: #2c3e50;
    }
    .reset-button {
      background: #e74c3c;
    }
    .button-group i {
      font-size: 1.1rem;
    }
    @media (max-width: 600px) {
      .button-group {
        padding: 0 0.75rem;
      }
      .button-group button {
        padding: 0.8rem 0.5rem;
      }
    }
    /* New styles for tabs and order section */
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #eee;
      padding: 0 0.5rem;
    }
    
    .tab {
      /* padding: 1rem 2rem; */
      background: transparent;
      border: none;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      color: #666;
      cursor: pointer;
      font-weight: 500;
    }
    
    .tab.active {
      color: #5c6e81;
      border-bottom: 2px solid #2c3e50;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    .order-items {
      margin: 1rem 0;
      border: 1px solid #eee;
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .order-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .order-item-actions button {
      width: auto;
      padding: 0.5rem;
      min-height: auto;
    }

    .discount-input {
      width: 80px;
      text-align: center;
    }

    footer {
      margin-top: 2rem;
      padding: 1rem;
      text-align: center;
      background: #f9f9f9;
      border-top: 1px solid #eee;
    }

    .main-content {
      min-height: calc(100vh - 200px);
    }
  </style>
</head>
<body>
  <div id="splash-screen">
    <img src="logo.png" alt="השוזר">
    <h1>השוזר - ניהול</h1>
  </div>
  <div class="container">
    <div class="header-container">
      <h1>ניהול הזמנות פרחים - השוזר</h1>
      <button id="settingsButton" class="settings-button" title="הגדרות">
        <i class="fas fa-cog"></i>
      </button>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="orders">הזמנות חדשות</button>
      <button class="tab" data-tab="items">ניהול פריטים</button>
      <button class="tab" data-tab="expenses">הוצאות</button>
      <button class="tab" data-tab="reports">דוחות</button>
    </div>

    <div class="main-content">
      <!-- Orders Tab -->
      <div id="orders" class="tab-content active">
        <div class="item-form">
          <h2>הזמנה חדשה</h2>
          <div class="flex-row">
            <input id="customerName" placeholder="שם הלקוח" />
            <input id="customerPhone" placeholder="טלפון" type="tel" />
          </div>
          <div class="flex-row">
            <input id="customerAddress" placeholder="כתובת למשלוח" />
            <input id="deliveryDate" type="datetime-local" placeholder="תאריך ושעת משלוח" />
          </div>
          <div class="flex-row">
            <input id="orderItemInput" placeholder="חפש פריט להוספה" />
            <button onclick="addItemToOrder()">הוסף פריט</button>
          </div>
          <div class="order-items" id="orderItemsList">
            <!-- Order items will be added here dynamically -->
          </div>
          <div class="summary" id="orderSummary">
            סה"כ: 0 ₪
          </div>
          <button onclick="submitOrder()">שמור הזמנה</button>
        </div>
      </div>

      <!-- Items Tab -->
      <div id="items" class="tab-content">
        <div class="item-form">
          <h2>פריט חדש</h2>
          <div class="flex-row">
            <input id="itemName" placeholder="שם מוצר (למשל: זר אהבה)" />
            <input id="itemPrice" type="number" placeholder="מחיר" />
          </div>
          <div class="flex-row">
            <input id="flowerInput" placeholder="בחר סוג פרח" />
            <input id="flowerQty" type="number" placeholder="כמות" />
            <button onclick="addIngredient()">הוסף פרח</button>
          </div>
          <ul id="ingredientsList"></ul>
          <button onclick="submitItem()">שמור פריט</button>
        </div>
      </div>

      <!-- Expenses Tab -->
      <div id="expenses" class="tab-content">
        <div class="item-form">
          <h2>הוצאה חדשה</h2>
          <div class="flex-row">
            <input id="expenseName" placeholder="שם ההוצאה" />
            <input id="expenseAmount" type="number" placeholder="סכום" />
          </div>
          <button onclick="submitExpense()">הוסף הוצאה</button>
        </div>
        <div class="report-section">
          <h3>הוצאות השבוע</h3>
          <div id="expensesList"></div>
        </div>
      </div>

      <!-- Reports Tab -->
      <div id="reports" class="tab-content">
        <div class="report-section">
          <h2>דוח שבועי</h2>
          <div class="button-group">
            <button onclick="printReport()" class="print-button">
              <i class="fas fa-print"></i>
              הדפס דוח
            </button>
            <button onclick="clearAllOrders()" class="reset-button">
              <i class="fas fa-trash"></i>
              איפוס הזמנות
            </button>
          </div>
          <div id="reportOutput"></div>
        </div>
      </div>
    </div>

    <footer>
      <p>© 2024 השוזר - כל הזכויות שמורות</p>
    </footer>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>ניהול סוגי פרחים</h2>
        <div class="flex-row">
          <input id="newFlowerType" placeholder="הוסף סוג פרח חדש" />
          <input id="newFlowerPrice" type="number" placeholder="מחיר ליחידה" />
          <button onclick="addNewFlowerType()">הוסף</button>
        </div>
        <table id="flowerTypeList">
          <thead>
            <tr>
              <th>סוג פרח</th>
              <th>מחיר ליחידה</th>
              <th>פעולות</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Splash screen handler
    window.addEventListener('load', function() {
      const container = document.querySelector('.container');
      setTimeout(function() {
        document.getElementById('splash-screen').classList.add('fade-out');
        setTimeout(function() {
          document.getElementById('splash-screen').style.display = 'none';
          container.classList.add('show');
          
          // Initialize Firebase Auth UI
          initAuth();
        }, 500);
      }, 1500);
    });

    // Auth initialization
    function initAuth() {
      // Enable persistent login
      auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
        .then(() => {
          // Check if user is already signed in
          auth.onAuthStateChanged((user) => {
            if (user) {
              // Show the container first
              const container = document.querySelector('.container');
              container.style.display = 'block';
              // Hide the splash screen
              const splashScreen = document.getElementById('splash-screen');
              if (splashScreen) {
                splashScreen.style.display = 'none';
              }
              // Initialize all components
              $(document).ready(() => {
                loadInitialData();
              });
            } else {
              // Show login form
              showLoginForm();
            }
          });
        })
        .catch((error) => {
          console.error('Error setting auth persistence:', error);
          alert('שגיאה בהגדרת התחברות מתמשכת: ' + error.message);
        });
    }

    function showLoginForm() {
      const loginHtml = `
        <div id="login-form" style="max-width: 400px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
          <h2 style="text-align: center; margin-bottom: 2rem;">כניסה למערכת</h2>
          <div style="margin-bottom: 1rem;">
            <input type="email" id="login-email" placeholder="אימייל" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;">
            <input type="password" id="login-password" placeholder="סיסמה" style="width: 100%; padding: 0.75rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <button onclick="login()" style="width: 100%; padding: 0.75rem; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer;">כניסה</button>
        </div>
      `;
      document.querySelector('.container').innerHTML = loginHtml;
    }

    async function login() {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      // Show loading state
      const loginButton = document.querySelector('button[onclick="login()"]');
      const originalText = loginButton.innerHTML;
      loginButton.innerHTML = 'מתחבר...';
      loginButton.disabled = true;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        // Reload the page to ensure proper initialization
        location.reload();
      } catch (error) {
        console.error('Login error:', error);
        alert('שגיאה בהתחברות: ' + error.message);
        loginButton.innerHTML = originalText;
        loginButton.disabled = false;
      }
    }

    function loadInitialData() {
      try {
        // Load all initial data
        loadFlowerTypes();
        updateExpensesList();
        initializeOrderAutocomplete();
        // Generate report last, when all other data is loaded
        setTimeout(() => {
          generateReport();
        }, 1000);
      } catch (error) {
        console.error('Error loading initial data:', error);
      }
    }

    // Firebase data operations
    function loadFlowerTypes() {
      db.ref(PATHS.FLOWERS).once('value', (snapshot) => {
        const flowers = snapshot.val() || defaultFlowers;
        if (!snapshot.exists()) {
          // Initialize with default flowers if none exist
          db.ref(PATHS.FLOWERS).set(defaultFlowers);
        }
        updateFlowerTypeList();
        initializeAutocomplete();
      });
    }

    function addNewFlowerType() {
      const newType = document.getElementById('newFlowerType').value.trim();
      const newPrice = parseFloat(document.getElementById('newFlowerPrice').value);
      
      if (!newType || isNaN(newPrice) || newPrice <= 0) {
        alert('נא להזין שם פרח ומחיר תקין');
        return;
      }

      // Show loading state
      const addButton = document.querySelector('button[onclick="addNewFlowerType()"]');
      const originalText = addButton.innerHTML;
      addButton.innerHTML = 'מוסיף...';
      addButton.disabled = true;

      db.ref(`${PATHS.FLOWERS}/${newType}`).once('value', (snapshot) => {
        if (snapshot.exists()) {
          alert('פרח זה כבר קיים במערכת');
          addButton.innerHTML = originalText;
          addButton.disabled = false;
          return;
        }

        db.ref(`${PATHS.FLOWERS}/${newType}`).set(newPrice)
          .then(() => {
            document.getElementById('newFlowerType').value = '';
            document.getElementById('newFlowerPrice').value = '';
            updateFlowerTypeList();
            initializeAutocomplete();
            alert('הפרח נוסף בהצלחה!');
          })
          .catch((error) => {
            console.error('Error saving flower:', error);
            alert('שגיאה בשמירת הפרח: ' + error.message);
          })
          .finally(() => {
            addButton.innerHTML = originalText;
            addButton.disabled = false;
          });
      });
    }

    function deleteFlowerType(type) {
      if (confirm(`האם למחוק את הפרח "${type}"?`)) {
        // Show loading state
        const deleteButton = event.target;
        const originalText = deleteButton.innerHTML;
        deleteButton.innerHTML = 'מוחק...';
        deleteButton.disabled = true;

        db.ref(`${PATHS.FLOWERS}/${type}`).remove()
          .then(() => {
            updateFlowerTypeList();
            initializeAutocomplete();
            alert('הפרח נמחק בהצלחה!');
          })
          .catch((error) => {
            console.error('Error deleting flower:', error);
            alert('שגיאה במחיקת הפרח: ' + error.message);
            deleteButton.innerHTML = originalText;
            deleteButton.disabled = false;
          });
      }
    }

    function updateFlowerTypeList() {
      const list = document.getElementById('flowerTypeList').getElementsByTagName('tbody')[0];
      
      // Show loading state
      list.innerHTML = '<tr><td colspan="3" style="text-align: center;">טוען...</td></tr>';
      
      db.ref(PATHS.FLOWERS).once('value', (snapshot) => {
        const flowers = snapshot.val() || {};
        
        list.innerHTML = '';
        Object.entries(flowers).forEach(([name, price]) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${name}</td>
            <td>${price} ₪</td>
            <td><button onclick="deleteFlowerType('${name}')">מחק</button></td>
          `;
          list.appendChild(row);
        });

        if (Object.keys(flowers).length === 0) {
          list.innerHTML = '<tr><td colspan="3" style="text-align: center;">אין פרחים במערכת</td></tr>';
        }
      }).catch(error => {
        console.error('Error loading flowers:', error);
        list.innerHTML = '<tr><td colspan="3" style="text-align: center; color: red;">שגיאה בטעינת הפרחים</td></tr>';
      });
    }

    function initializeAutocomplete() {
      const flowerInput = $("#flowerInput");
      
      db.ref(PATHS.FLOWERS).once('value', (snapshot) => {
        const flowers = snapshot.val() || {};
        
        flowerInput.autocomplete({
          source: Object.keys(flowers),
          minLength: 0,
          select: function(event, ui) {
            flowerInput.val(ui.item.value);
            return false;
          }
        }).focus(function() {
          $(this).autocomplete("search", "");
        });
      });
    }

    document.getElementById('settingsButton').onclick = function() {
      document.getElementById('settingsModal').style.display = 'block';
      updateFlowerTypeList();
    };

    document.querySelector('.close').onclick = function() {
      document.getElementById('settingsModal').style.display = 'none';
    };

    window.onclick = function(event) {
      if (event.target == document.getElementById('settingsModal')) {
        document.getElementById('settingsModal').style.display = 'none';
      }
    };

    $(function() {
      initializeAutocomplete();
      updateFlowerTypeList();
    });

    loadFlowerTypes();
    autoResetItems();
    generateReport();

    // New code for orders
    let currentOrder = {
      items: [],
      total: 0
    };

    function switchTab(tabId) {
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      document.getElementById(tabId).classList.add('active');
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

      // Refresh data when switching to specific tabs
      if (tabId === 'reports') {
        generateReport();
      } else if (tabId === 'expenses') {
        updateExpensesList();
      }
    }

    function addItemToOrder() {
      const itemName = document.getElementById('orderItemInput').value.trim();
      
      // Show loading state
      const addButton = document.querySelector('button[onclick="addItemToOrder()"]');
      const originalText = addButton.innerHTML;
      addButton.innerHTML = 'מוסיף...';
      addButton.disabled = true;
      
      db.ref(PATHS.ITEMS).once('value', (snapshot) => {
        const items = [];
        snapshot.forEach(child => {
          items.push(child.val());
        });
        
        const item = items.find(i => i.name === itemName);
        
        if (!item) {
          alert('נא לבחור פריט מהרשימה');
          addButton.innerHTML = originalText;
          addButton.disabled = false;
          return;
        }

        currentOrder.items.push({
          ...item,
          discount: 0,
          finalPrice: item.price
        });

        updateOrderItemsList();
        document.getElementById('orderItemInput').value = '';
        addButton.innerHTML = originalText;
        addButton.disabled = false;
      }).catch(error => {
        console.error('Error adding item to order:', error);
        alert('שגיאה בהוספת הפריט: ' + error.message);
        addButton.innerHTML = originalText;
        addButton.disabled = false;
      });
    }

    function updateOrderItemsList() {
      const list = document.getElementById('orderItemsList');
      list.innerHTML = '';
      
      currentOrder.total = 0;
      
      currentOrder.items.forEach((item, index) => {
        const div = document.createElement('div');
        div.className = 'order-item';
        div.innerHTML = `
          <div>${item.name}</div>
          <div>${item.price} ₪</div>
          <div>
            <input type="number" 
              class="discount-input" 
              value="${item.discount}" 
              min="0" 
              max="100" 
              onchange="updateDiscount(${index}, this.value)" 
              placeholder="הנחה %" />
          </div>
          <div>מחיר סופי: ${item.finalPrice} ₪</div>
          <div class="order-item-actions">
            <button onclick="removeOrderItem(${index})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        list.appendChild(div);
        currentOrder.total += item.finalPrice;
      });

      document.getElementById('orderSummary').innerHTML = `סה"כ: ${currentOrder.total} ₪`;
    }

    function updateDiscount(index, discount) {
      discount = parseFloat(discount) || 0;
      if (discount < 0) discount = 0;
      if (discount > 100) discount = 100;

      const item = currentOrder.items[index];
      item.discount = discount;
      item.finalPrice = item.price * (1 - discount / 100);
      updateOrderItemsList();
    }

    function removeOrderItem(index) {
      currentOrder.items.splice(index, 1);
      updateOrderItemsList();
    }

    function submitOrder() {
      const name = document.getElementById('customerName').value.trim();
      const phone = document.getElementById('customerPhone').value.trim();
      const address = document.getElementById('customerAddress').value.trim();
      const deliveryDate = document.getElementById('deliveryDate').value;

      if (!name || !phone || !address || !deliveryDate || currentOrder.items.length === 0) {
        alert('נא למלא את כל פרטי ההזמנה');
        return;
      }

      // Show loading state
      const submitButton = document.querySelector('button[onclick="submitOrder()"]');
      const originalText = submitButton.innerHTML;
      submitButton.innerHTML = 'שומר...';
      submitButton.disabled = true;

      const newOrder = {
        ...currentOrder,
        customer: { name, phone, address },
        deliveryDate,
        orderDate: new Date().toISOString(),
        status: 'new',
        createdBy: auth.currentUser.email
      };

      console.log('Attempting to save order:', newOrder);

      db.ref(PATHS.ORDERS).push(newOrder)
        .then(() => {
          console.log('Order saved successfully');
          // Reset form
          document.getElementById('customerName').value = '';
          document.getElementById('customerPhone').value = '';
          document.getElementById('customerAddress').value = '';
          document.getElementById('deliveryDate').value = '';
          currentOrder = { items: [], total: 0 };
          updateOrderItemsList();
          
          alert('ההזמנה נשמרה בהצלחה!');
        })
        .catch((error) => {
          console.error('Error submitting order:', error);
          alert('שגיאה בשמירת ההזמנה: ' + error.message);
        })
        .finally(() => {
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        });
    }

    // Initialize tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        switchTab(tab.dataset.tab);
      });
    });

    // Initialize order item autocomplete
    function initializeOrderAutocomplete() {
      db.ref(PATHS.ITEMS).once('value', (snapshot) => {
        const items = [];
        snapshot.forEach(child => {
          items.push(child.val());
        });

        $("#orderItemInput").autocomplete({
          source: items.map(i => i.name),
          minLength: 0,
          select: function(event, ui) {
            $(this).val(ui.item.value);
            return false;
          }
        }).focus(function() {
          $(this).autocomplete("search", "");
        });
      });
    }

    // Initialize everything when the page loads
    $(function() {
      setupRealtimeListeners();
      autoResetItems(); // Call it on load
    });

    // New functions for expenses
    function submitExpense() {
      const name = document.getElementById('expenseName').value.trim();
      const amount = parseFloat(document.getElementById('expenseAmount').value);

      if (!name || !amount || amount <= 0) {
        alert('נא למלא שם הוצאה וסכום תקין');
        return;
      }

      // Show loading state
      const submitButton = document.querySelector('button[onclick="submitExpense()"]');
      const originalText = submitButton.innerHTML;
      submitButton.innerHTML = 'שומר...';
      submitButton.disabled = true;

      const newExpense = {
        name,
        amount,
        date: new Date().toISOString(),
        createdBy: auth.currentUser.email
      };

      db.ref(PATHS.EXPENSES).push(newExpense)
        .then(() => {
          document.getElementById('expenseName').value = '';
          document.getElementById('expenseAmount').value = '';
          updateExpensesList();
          generateReport();
          alert('ההוצאה נשמרה בהצלחה!');
        })
        .catch((error) => {
          console.error('Error submitting expense:', error);
          alert('שגיאה בשמירת ההוצאה: ' + error.message);
        })
        .finally(() => {
          submitButton.innerHTML = originalText;
          submitButton.disabled = false;
        });
    }

    function updateExpensesList() {
      const list = document.getElementById('expensesList');
      const { start, end } = getWeekRange();

      db.ref(PATHS.EXPENSES)
        .orderByChild('date')
        .startAt(start.toISOString())
        .endAt(end.toISOString())
        .once('value', (snapshot) => {
          const expenses = [];
          snapshot.forEach(child => {
            expenses.push(child.val());
          });

          if (expenses.length === 0) {
            list.innerHTML = '<p>אין הוצאות השבוע</p>';
            return;
          }

          const grouped = groupByDay(expenses);
          let html = '';

          Object.keys(grouped).sort().forEach(date => {
            const dayExpenses = grouped[date];
            let dayTotal = 0;
            
            html += `<h4>${date}</h4><ul>`;
            dayExpenses.forEach(expense => {
              dayTotal += expense.amount;
              html += `<li>${expense.name}: ${expense.amount} ₪</li>`;
            });
            html += `<li class="summary">סה"כ ליום: ${dayTotal} ₪</li></ul>`;
          });

          const weeklyTotal = expenses.reduce((sum, exp) => sum + exp.amount, 0);
          html += `<div class="summary">סה"כ הוצאות השבוע: ${weeklyTotal} ₪</div>`;

          list.innerHTML = html;
        });
    }

    // Set up real-time listeners
    function setupRealtimeListeners() {
      // Listen for new orders
      db.ref(PATHS.ORDERS).on('child_added', () => {
        generateReport();
      });

      // Listen for new expenses
      db.ref(PATHS.EXPENSES).on('child_added', () => {
        updateExpensesList();
        generateReport();
      });

      // Listen for flower type changes
      db.ref(PATHS.FLOWERS).on('value', () => {
        updateFlowerTypeList();
        initializeAutocomplete();
      });

      // Listen for item changes
      db.ref(PATHS.ITEMS).on('value', () => {
        initializeOrderAutocomplete();
      });
    }

    function autoResetItems() {
      const now = new Date();
      if (now.getDay() === 6 && now.getHours() >= 18) {
        // Reset items in Firebase instead of localStorage
        db.ref(PATHS.ITEMS).remove()
          .then(() => {
            console.log('Weekly items reset completed');
          })
          .catch((error) => {
            console.error('Error resetting items:', error);
          });
      }
    }

    function getWeekRange() {
      const now = new Date();
      const day = now.getDay();
      const diffToSunday = day;
      const start = new Date(now);
      start.setDate(now.getDate() - diffToSunday);
      start.setHours(0,0,0,0);
      const end = new Date(start);
      end.setDate(start.getDate() + 6);
      end.setHours(23,59,59,999);
      return { start, end };
    }

    function groupByDay(items) {
      const map = {};
      items.forEach(o => {
        const d = new Date(o.date || o.orderDate).toLocaleDateString();
        if (!map[d]) map[d] = [];
        map[d].push(o);
      });
      return map;
    }

    function generateReport() {
      const report = document.getElementById('reportOutput');
      report.innerHTML = '';
      const { start, end } = getWeekRange();

      // Get both orders and expenses data
      Promise.all([
        db.ref(PATHS.ORDERS)
          .orderByChild('orderDate')
          .startAt(start.toISOString())
          .endAt(end.toISOString())
          .once('value'),
        db.ref(PATHS.EXPENSES)
          .orderByChild('date')
          .startAt(start.toISOString())
          .endAt(end.toISOString())
          .once('value')
      ]).then(([ordersSnapshot, expensesSnapshot]) => {
        // Convert snapshots to arrays
        const orders = [];
        ordersSnapshot.forEach(child => {
          orders.push(child.val());
        });

        const expenses = [];
        expensesSnapshot.forEach(child => {
          expenses.push(child.val());
        });

        // Initialize weekly totals
        const weeklyTotals = {
          revenue: 0,
          cost: 0,
          expenses: 0,
          profit: 0,
          flowers: {}
        };

        // Create table structure
        const table = document.createElement('table');
        table.className = 'weekly-report-table';
        
        // Add table header
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr>
            <th>ראשון</th>
            <th>שני</th>
            <th>שלישי</th>
            <th>רביעי</th>
            <th>חמישי</th>
            <th>שישי</th>
            <th class="weekly-summary">סיכום שבועי</th>
          </tr>
        `;
        table.appendChild(thead);

        // Create table body with 3 rows (orders, expenses, totals)
        const tbody = document.createElement('tbody');
        
        // Orders row
        const ordersRow = document.createElement('tr');
        ordersRow.className = 'orders-row';

        // Expenses row
        const expensesRow = document.createElement('tr');
        expensesRow.className = 'expenses-row';

        // Totals row
        const totalsRow = document.createElement('tr');
        totalsRow.className = 'totals-row';

        // Process each day
        for (let i = 0; i < 7; i++) {
          const currentDate = new Date(start);
          currentDate.setDate(start.getDate() + i);
          const dateStr = currentDate.toLocaleDateString();
          
          const dayOrders = orders.filter(o => new Date(o.orderDate).toLocaleDateString() === dateStr);
          const dayExpenses = expenses.filter(e => new Date(e.date).toLocaleDateString() === dateStr);

          let dayRevenue = 0;
          let dayCost = 0;
          let dayExpensesTotal = 0;
          const dayFlowers = {};

          // Process orders
          let ordersHtml = '';
          dayOrders.forEach(order => {
            order.items.forEach(item => {
              dayRevenue += item.finalPrice;
              dayCost += item.totalCost || 0;
              ordersHtml += `<div class="order-item">
                ${item.name} - ${item.finalPrice} ₪
              </div>`;

              // Track flowers
              if (item.ingredients) {
                item.ingredients.forEach(ing => {
                  if (!dayFlowers[ing.name]) dayFlowers[ing.name] = 0;
                  if (!weeklyTotals.flowers[ing.name]) weeklyTotals.flowers[ing.name] = 0;
                  dayFlowers[ing.name] += ing.qty;
                  weeklyTotals.flowers[ing.name] += ing.qty;
                });
              }
            });
          });

          // Process expenses
          let expensesHtml = '';
          dayExpenses.forEach(expense => {
            dayExpensesTotal += expense.amount;
            expensesHtml += `<div class="expense-item">
              ${expense.name} - ${expense.amount} ₪
            </div>`;
          });

          // Update weekly totals
          weeklyTotals.revenue += dayRevenue;
          weeklyTotals.cost += dayCost;
          weeklyTotals.expenses += dayExpensesTotal;
          weeklyTotals.profit += (dayRevenue - dayCost - dayExpensesTotal);

          // Create day cells
          if (i < 6) { // Sunday to Friday
            // Orders cell
            const ordersCell = document.createElement('td');
            ordersCell.innerHTML = ordersHtml || '<div class="no-data">אין הזמנות</div>';
            ordersRow.appendChild(ordersCell);

            // Expenses cell
            const expensesCell = document.createElement('td');
            expensesCell.innerHTML = expensesHtml || '<div class="no-data">אין הוצאות</div>';
            expensesRow.appendChild(expensesCell);

            // Totals cell
            const totalsCell = document.createElement('td');
            totalsCell.innerHTML = `
              <div class="day-totals">
                ${Object.entries(dayFlowers).map(([flower, qty]) => 
                  `<div>${flower}: ${qty}</div>`).join('')}
                <div class="summary">מכירות: ${dayRevenue} ₪</div>
                <div class="summary">עלויות: ${dayCost} ₪</div>
                <div class="summary">הוצאות: ${dayExpensesTotal} ₪</div>
                <div class="summary">רווח נקי: ${dayRevenue - dayCost - dayExpensesTotal} ₪</div>
              </div>
            `;
            totalsRow.appendChild(totalsCell);
          }
        }

        // Add weekly summary column
        const weeklyOrdersCell = document.createElement('td');
        weeklyOrdersCell.className = 'weekly-summary';
        weeklyOrdersCell.rowSpan = 3;
        weeklyOrdersCell.innerHTML = `
          <div class="weekly-totals">
            <h4>סיכום פרחים</h4>
            ${Object.entries(weeklyTotals.flowers).map(([flower, qty]) => 
              `<div>${flower}: ${qty}</div>`).join('')}
            <h4>סיכום כספי</h4>
            <div class="summary">סה"כ מכירות: ${weeklyTotals.revenue} ₪</div>
            <div class="summary">סה"כ עלויות: ${weeklyTotals.cost} ₪</div>
            <div class="summary">סה"כ הוצאות: ${weeklyTotals.expenses} ₪</div>
            <div class="summary">סה"כ רווח נקי: ${weeklyTotals.profit} ₪</div>
          </div>
        `;
        ordersRow.appendChild(weeklyOrdersCell);

        tbody.appendChild(ordersRow);
        tbody.appendChild(expensesRow);
        tbody.appendChild(totalsRow);
        table.appendChild(tbody);
        report.appendChild(table);
      }).catch(error => {
        console.error('Error generating report:', error);
        report.innerHTML = '<div class="error">שגיאה בטעינת הדוח</div>';
      });
    }
  </script>
</body>
</html>
